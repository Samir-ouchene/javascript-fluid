<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Javascript fluid dynamics</title>
<script language="javascript" type="text/javascript" src="fluid.js"></script>
<script language="javascript" type="text/javascript">

var ctx;
var image_data;
var timer;
var iteration = 0;

var dt = 1;
var diff = 100;

function getRed(data)
{
    var ret = [];
    for (var i=0; i < data.length; i+=4)
    {
        ret.push(data[i]);
    }
    return ret;
}

function fromRed(dst,data)
{
    for (var i=0; i < data.length; i++)
    {
        dst[4*i] = data[i];
        dst[4*i + 1] = data[i];
        dst[4*i + 2] = data[i];
        dst[4*i + 3] = 255;
    }
}

function run()
{
    iteration++;
    ///////////
    var data = [];
    diffuse(ctx.canvas.width, data, getRed(image_data), diff, dt);
    var imgd = ctx.createImageData(size, size);
    fromRed(imgd.data, data);
    ctx.putImageData(imgd,0,0);
    image_data = imgd.data;
    ///////////
    timer = setTimeout(run, 100);
}

function init()
{
    var img = document.getElementById("fluid_image");
    var canvas = document.getElementById("fluid_canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    ctx = canvas.getContext("2d");
    ctx.drawImage(img,0,0);
    try
    {
        image_data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    }
    catch(e)
    {
        try
        {
            netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
        }
        catch(ev){}
        image_data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    }
}

function toggle()
{
    if (timer)
    {
        clearTimeout(timer);
    }
    else
    {
        setTimeout(run,10);
    }
}

</script>
</head>
<body onload="init();">
<img id="fluid_image" src="canvas.png" />
<canvas id="fluid_canvas"></canvas><br />
<button onclick="toggle();">Start/Stop</button><br />
<div id="score"></div>
</body>
</html>